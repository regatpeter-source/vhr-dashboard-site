version: '3.8'

services:
  # Node.js Server (VHR Dashboard)
  dashboard:
    build: .
    container_name: vhr-dashboard
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - NO_ADB=1
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-this}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
    volumes:
      - ./data:/app/data
      - ./tts-receiver-app:/app/tts-receiver-app
    depends_on:
      - apk-builder
    networks:
      - vhr-network

  # Android APK Builder Service (Linux avec Gradle)
  apk-builder:
    image: ubuntu:22.04
    container_name: vhr-apk-builder
    working_dir: /app
    environment:
      - ANDROID_HOME=/opt/android-sdk
      - GRADLE_USER_HOME=/gradle-cache
    volumes:
      - ./tts-receiver-app:/app
      - apk-cache:/gradle-cache
      - sdk-cache:/opt/android-sdk
      - ./tts-receiver-app/build:/app/build
    ports:
      - "5000:5000"  # Pour écouter les requêtes de compilation
    command: /bin/bash -c "
      apt-get update && apt-get install -y openjdk-11-jdk wget git unzip &&
      mkdir -p /opt/android-sdk &&
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O /tmp/cmdline-tools.zip &&
      unzip -q /tmp/cmdline-tools.zip -d /opt/android-sdk &&
      mv /opt/android-sdk/cmdline-tools /opt/android-sdk/latest &&
      mkdir -p /opt/android-sdk/cmdline-tools &&
      mv /opt/android-sdk/latest /opt/android-sdk/cmdline-tools/latest &&
      yes | /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/opt/android-sdk --licenses > /dev/null 2>&1 || true &&
      /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/opt/android-sdk 'platforms;android-32' 'build-tools;32.0.0' &&
      cd /app &&
      chmod +x gradlew &&
      ./gradlew assemble\$\${BUILD_TYPE:-Debug} -Dorg.gradle.jvmargs='-Xmx4096m' --no-daemon &&
      echo 'APK built successfully!'
      "
    networks:
      - vhr-network

volumes:
  apk-cache:
  sdk-cache:

networks:
  vhr-network:
    driver: bridge
