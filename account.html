<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mon compte — VHR DASHBOARD</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo">VHR DASHBOARD</div>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="features.html">Fonctionnalités</a></li>
        <li><a href="pricing.html">Tarifs</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="account.html" class="active">Mon compte</a></li>
      </ul>
    </nav>
  </header>
  <main style="max-width:900px;margin:36px auto;padding:18px;">
    <h1>Mon compte</h1>
    <div id="accountBox">
      <div id="loggedOutBox">
        <p>Connectez-vous pour accéder à votre espace client.</p>
        <form id="loginForm">
          <label>Nom d'utilisateur:<br><input type="text" id="username" required></label><br>
          <label>Mot de passe:<br><input type="password" id="password" required></label><br>
          <button type="submit" class="cta">Se connecter</button>
        </form>
        <div id="loginMessage"></div>
      </div>
      <div id="loggedInBox" style="display:none;">
        <h2>Bienvenue, <span id="accountName"></span></h2>
        <p>Rôle: <span id="accountRole"></span></p>
        <p>Vous êtes connecté·e. Ici vous pourrez afficher vos abonnements, factures et paramètres.</p>
        <button id="logoutBtn" class="cta-secondary">Se déconnecter</button>
      </div>
    </div>
  </main>
  <script>
    async function api(path, opts = {}) {
      try { const res = await fetch(path, opts); return await res.json(); } catch(e){ return { ok: false, error: e.message }; }
    }

    const loginForm = document.getElementById('loginForm');
    const loggedInBox = document.getElementById('loggedInBox');
    const loggedOutBox = document.getElementById('loggedOutBox');
    const loginMessage = document.getElementById('loginMessage');
    const accountName = document.getElementById('accountName');
    const accountRole = document.getElementById('accountRole');
    const logoutBtn = document.getElementById('logoutBtn');

    function setToken(t) { if (t) localStorage.setItem('vhr_token', t); else localStorage.removeItem('vhr_token'); }
    function getToken() { return localStorage.getItem('vhr_token'); }

    async function loadMe() {
      const token = getToken();
      if (!token) { showLoggedOut(); return; }
      try {
        const res = await fetch('/api/me', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) { showLoggedOut(); return; }
        const json = await res.json();
        if (!json || !json.ok) { showLoggedOut(); return; }
        showLoggedIn(json.user);
      } catch (e) { showLoggedOut(); }
    }

    function showLoggedIn(user) {
      loggedOutBox.style.display = 'none';
      loggedInBox.style.display = 'block';
      accountName.textContent = user.username || '(inconnu)';
      accountRole.textContent = user.role || '(-- )';
    }
    function showLoggedOut() {
      loggedOutBox.style.display = 'block';
      loggedInBox.style.display = 'none';
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      loginMessage.textContent = 'Connexion...';
      const res = await api('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
      if (res && res.ok && res.token) { setToken(res.token); loginMessage.textContent = 'Connexion réussie'; await loadMe(); }
      else { loginMessage.textContent = 'Erreur: ' + (res && res.error ? res.error : 'Erreur inconnue'); }
    });

    logoutBtn.addEventListener('click', async () => { setToken(null); await api('/api/logout', { method: 'POST' }); showLoggedOut(); });

    loadMe();
  </script>
</body>
</html>
