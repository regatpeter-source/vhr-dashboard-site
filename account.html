<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mon compte — VHR DASHBOARD</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <nav>
      <div class="logo">VHR DASHBOARD</div>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="features.html">Fonctionnalités</a></li>
        <li><a href="pricing.html">Tarifs</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="account.html" class="active">Mon compte</a></li>
      </ul>
    </nav>
  </header>
  <main style="max-width:900px;margin:36px auto;padding:18px;">
    <h1>Mon compte</h1>
    <div id="accountBox">
      <div id="loggedOutBox">
          <p>Connectez-vous pour accéder à votre espace client ou créez un compte.</p>
          <div id="authForms">
            <form id="loginForm" style="margin-bottom:18px;">
              <label>Nom d'utilisateur:<br><input type="text" id="username" required></label><br>
              <label>Mot de passe:<br><input type="password" id="password" required></label><br>
              <button type="submit" class="cta">Se connecter</button>
            </form>
            <form id="signupForm">
              <h3>Créer un compte</h3>
              <label>Nom d'utilisateur:<br><input type="text" id="signupUsername" required></label><br>
              <label>Email:<br><input type="email" id="signupEmail"></label><br>
              <label>Mot de passe:<br><input type="password" id="signupPassword" required></label><br>
              <label>Confirmer le mot de passe:<br><input type="password" id="signupPasswordConfirm" required></label><br>
              <button type="submit" class="cta-secondary">Créer un compte</button>
            </form>
          </div>
          <div id="loginMessage"></div>
        </div>
      <div id="loggedInBox" style="display:none;">
        <h2>Bienvenue, <span id="accountName"></span></h2>
        <p>Rôle: <span id="accountRole"></span></p>
        <p>Vous êtes connecté·e. Ici vous pourrez afficher vos abonnements, factures et paramètres.</p>
        <section id="billingBox"></section>
        <section id="profileBox">
          <h3>Modifier mon profil</h3>
          <form id="profileForm">
            <label>Nom d'utilisateur:<br><input type="text" id="profileUsername"></label><br>
            <label>Email:<br><input type="email" id="profileEmail"></label><br>
            <button type="submit" class="cta">Mettre à jour</button>
          </form>
          <div id="profileMessage"></div>
          <h3>Changer le mot de passe</h3>
          <form id="passwordForm">
            <label>Ancien mot de passe:<br><input type="password" id="oldPassword"></label><br>
            <label>Nouveau mot de passe:<br><input type="password" id="newPassword"></label><br>
            <button type="submit" class="cta">Changer le mot de passe</button>
          </form>
          <div id="passwordMessage"></div>
        </section>
        <p><button id="logoutBtn" class="cta-secondary">Se déconnecter</button></p>
      </div>
    </div>
  </main>
  <script src="/js/account.js"></script>
      try {
        const invResp = await api('/api/billing/invoices');
        const subsResp = await api('/api/billing/subscriptions');
        const billingBox = document.getElementById('billingBox');
        if (!billingBox) return;
        let html = '';
        if (subsResp.ok && subsResp.subscriptions && subsResp.subscriptions.length) {
          html += '<h3>Abonnements</h3><ul>';
          subsResp.subscriptions.forEach(s => { html += `<li>${s.id} – ${s.status} – ${s.items?.data?.map(it => it.price.product || it.price.id).join(', ')}</li>`; });
          html += '</ul>';
        } else html += '<p>Aucun abonnement.</p>';
        if (invResp.ok && invResp.invoices && invResp.invoices.length) {
          html += '<h3>Factures</h3><ul>';
          invResp.invoices.forEach(i => { html += `<li>${i.id} – ${i.status} – ${i.amount_paid/100} ${i.currency.toUpperCase()} – <a href="${i.invoice_pdf}" target="_blank">PDF</a></li>`; });
          html += '</ul>';
        } else html += '<p>Aucune facture.</p>';
        html += '<p><button id="manageBillingBtn" class="cta-secondary">Gérer la facturation</button></p>';
        billingBox.innerHTML = html;
        const btn = document.getElementById('manageBillingBtn');
        if (btn) btn.onclick = async () => {
          const resp = await api('/api/billing/portal', { method: 'POST' });
          if (resp.ok && resp.url) window.location = resp.url;
          else alert('Impossible d\'ouvrir le portail de facturation. ' + (resp.error || ''));
        }
      } catch (e) {
        console.error('billing load', e);
      }
    }

    // Profile update
    const profileForm = document.getElementById('profileForm');
    const passwordForm = document.getElementById('passwordForm');
    profileForm && profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('profileUsername').value;
      const email = document.getElementById('profileEmail').value;
      const res = await api('/api/me', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, email }) });
      const msg = document.getElementById('profileMessage');
      if (res && res.ok) { msg.textContent = 'Profil mis à jour'; await loadMe(); } else { msg.textContent = 'Erreur: ' + (res && res.error ? res.error : 'inconnue'); }
    });
    passwordForm && passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const res = await api('/api/me', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ oldPassword, newPassword }) });
      const msg = document.getElementById('passwordMessage');
      if (res && res.ok) { msg.textContent = 'Mot de passe changé'; } else { msg.textContent = 'Erreur: ' + (res && res.error ? res.error : 'inconnue'); }
    });
  </script>
</body>
</html>
